{% extends "base.html" %}

{% block title %}問題一覧 - 英語リスニングアプリ{% endblock %}

{% block content %}
<!-- ページヘッダー -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                <i class="fas fa-question-circle me-2"></i>問題一覧
            </h2>
            <a href="{{ url_for('upload') }}" class="btn btn-success">
                <i class="fas fa-upload me-2"></i>音声アップロード
            </a>
        </div>
    </div>
</div>

<!-- フィルターと検索 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row g-3">
                    <!-- 検索バー -->
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" placeholder="問題文で検索...">
                        </div>
                    </div>
                    
                    <!-- 難易度フィルター -->
                    <div class="col-md-2">
                        <select class="form-select" id="difficultyFilter">
                            <option value="">難易度</option>
                            <option value="easy">初級</option>
                            <option value="medium">中級</option>
                            <option value="hard">上級</option>
                        </select>
                    </div>
                    
                    <!-- カテゴリフィルター -->
                    <div class="col-md-2">
                        <select class="form-select" id="categoryFilter">
                            <option value="">カテゴリ</option>
                            <option value="conversation">会話</option>
                            <option value="news">ニュース</option>
                            <option value="story">物語</option>
                            <option value="academic">学術</option>
                        </select>
                    </div>
                    
                    <!-- 並び順 -->
                    <div class="col-md-2">
                        <select class="form-select" id="sortOrder">
                            <option value="newest">新着順</option>
                            <option value="oldest">古い順</option>
                            <option value="popular">人気順</option>
                        </select>
                    </div>
                    
                    <!-- フィルターリセット -->
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                            <i class="fas fa-undo me-1"></i>リセット
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 問題一覧 -->
<div class="row" id="questionsContainer">
    <!-- 問題カードがここに動的に表示されます -->
</div>

<!-- ページネーション -->
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="問題一覧のページネーション">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- ページネーションがここに動的に表示されます -->
            </ul>
        </nav>
    </div>
</div>

<!-- ローディングスピナー -->
<div class="text-center py-5" id="loadingSpinner" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">読み込み中...</span>
    </div>
    <p class="mt-2 text-muted">問題を読み込み中...</p>
</div>

<!-- 問題が見つからない場合 -->
<div class="text-center py-5" id="noQuestions" style="display: none;">
    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
    <h5 class="text-muted">問題が見つかりません</h5>
    <p class="text-muted">フィルターを変更するか、新しい音声をアップロードしてください。</p>
    <a href="{{ url_for('upload') }}" class="btn btn-primary">
        <i class="fas fa-upload me-2"></i>音声をアップロード
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
// グローバル変数
let currentPage = 1;
let questionsPerPage = 12;
let allQuestions = [];
let filteredQuestions = [];

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    loadQuestions();
    setupEventListeners();
});

// イベントリスナーの設定
function setupEventListeners() {
    // 検索入力
    document.getElementById('searchInput').addEventListener('input', debounce(filterQuestions, 300));
    
    // フィルター変更
    document.getElementById('difficultyFilter').addEventListener('change', filterQuestions);
    document.getElementById('categoryFilter').addEventListener('change', filterQuestions);
    document.getElementById('sortOrder').addEventListener('change', filterQuestions);
}

// 問題の読み込み
async function loadQuestions() {
    showLoading(true);
    
    try {
        const response = await fetch('/api/questions/public');
        if (response.ok) {
            allQuestions = await response.json();
            filterQuestions();
        } else {
            throw new Error('問題の読み込みに失敗しました');
        }
    } catch (error) {
        console.error('Error:', error);
        showError('問題の読み込みに失敗しました。ページを再読み込みしてください。');
    } finally {
        showLoading(false);
    }
}

// 問題のフィルタリング
function filterQuestions() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const difficulty = document.getElementById('difficultyFilter').value;
    const category = document.getElementById('categoryFilter').value;
    const sortOrder = document.getElementById('sortOrder').value;
    
    // フィルタリング
    filteredQuestions = allQuestions.filter(question => {
        const matchesSearch = question.question_text.toLowerCase().includes(searchTerm);
        const matchesDifficulty = !difficulty || question.difficulty === difficulty;
        const matchesCategory = !category || question.category === category;
        
        return matchesSearch && matchesDifficulty && matchesCategory;
    });
    
    // ソート
    sortQuestions(sortOrder);
    
    // 表示
    currentPage = 1;
    displayQuestions();
    updatePagination();
}

// 問題のソート
function sortQuestions(sortOrder) {
    switch (sortOrder) {
        case 'newest':
            filteredQuestions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            break;
        case 'oldest':
            filteredQuestions.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            break;
        case 'popular':
            filteredQuestions.sort((a, b) => (b.play_count || 0) - (a.play_count || 0));
            break;
    }
}

// 問題の表示
function displayQuestions() {
    const container = document.getElementById('questionsContainer');
    const startIndex = (currentPage - 1) * questionsPerPage;
    const endIndex = startIndex + questionsPerPage;
    const pageQuestions = filteredQuestions.slice(startIndex, endIndex);
    
    if (pageQuestions.length === 0) {
        showNoQuestions();
        return;
    }
    
    container.innerHTML = pageQuestions.map(question => createQuestionCard(question)).join('');
}

// 問題カードの作成
function createQuestionCard(question) {
    const difficultyBadge = getDifficultyBadge(question.difficulty);
    const categoryBadge = getCategoryBadge(question.category);
    
    return `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm question-card" data-question-id="${question.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        ${difficultyBadge}
                        ${categoryBadge}
                    </div>
                    
                    <h6 class="card-title">${question.question_text.substring(0, 60)}${question.question_text.length > 60 ? '...' : ''}</h6>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>${question.uploader && question.uploader.username ? question.uploader.username : 'Unknown'}
                        </small>
                        <br>
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>${formatDate(question.created_at)}
                        </small>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-info">
                            <i class="fas fa-play me-1"></i>${question.play_count || 0}回
                        </span>
                        <span class="badge bg-success">
                            <i class="fas fa-star me-1"></i>${question.avg_score || 0}点
                        </span>
                    </div>
                    
                    <div class="d-grid">
                        <a href="/learn/${question.id}" class="btn btn-primary">
                            <i class="fas fa-play me-2"></i>学習開始
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// 難易度バッジの取得
function getDifficultyBadge(difficulty) {
    const badges = {
        'easy': '<span class="badge bg-success">初級</span>',
        'medium': '<span class="badge bg-warning">中級</span>',
        'hard': '<span class="badge bg-danger">上級</span>'
    };
    return badges[difficulty] || '<span class="badge bg-secondary">未設定</span>';
}

// カテゴリバッジの取得
function getCategoryBadge(category) {
    const badges = {
        'conversation': '<span class="badge bg-primary">会話</span>',
        'news': '<span class="badge bg-info">ニュース</span>',
        'story': '<span class="badge bg-warning">物語</span>',
        'academic': '<span class="badge bg-dark">学術</span>'
    };
    return badges[category] || '<span class="badge bg-secondary">未設定</span>';
}

// ページネーションの更新
function updatePagination() {
    const totalPages = Math.ceil(filteredQuestions.length / questionsPerPage);
    const pagination = document.getElementById('pagination');
    
    if (!pagination) return;
    
    if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
    }
    
    pagination.style.display = 'flex';
    
    let paginationHTML = '';
    
    // 前のページ
    if (currentPage > 1) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;
    }
    
    // ページ番号
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            paginationHTML += `
                <li class="page-item active">
                    <span class="page-link">${i}</span>
                </li>
            `;
        } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHTML += `
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            `;
        }
    }
    
    // 次のページ
    if (currentPage < totalPages) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;
    }
    
    pagination.innerHTML = paginationHTML;
}

// ページ変更
function changePage(page) {
    currentPage = page;
    displayQuestions();
    updatePagination();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// フィルターリセット
function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('difficultyFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('sortOrder').value = 'newest';
    filterQuestions();
}

// ローディング表示
function showLoading(show) {
    const loadingSpinner = document.getElementById('loadingSpinner');
    const questionsContainer = document.getElementById('questionsContainer');
    
    if (loadingSpinner) loadingSpinner.style.display = show ? 'block' : 'none';
    if (questionsContainer) questionsContainer.style.display = show ? 'none' : 'block';
}

// 問題が見つからない場合の表示
function showNoQuestions() {
    const container = document.getElementById('questionsContainer');
    const noQuestions = document.getElementById('noQuestions');
    const pagination = document.getElementById('pagination');
    
    if (container) container.innerHTML = '';
    if (noQuestions) noQuestions.style.display = 'block';
    if (pagination) pagination.style.display = 'none';
}

// エラー表示
function showError(message) {
    // 既存のエラー表示機能を使用
    if (window.AppUtils && window.AppUtils.showError) {
        window.AppUtils.showError(message);
    } else {
        // シンプルなエラー表示
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show';
        errorDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container');
        if (container) {
            container.insertBefore(errorDiv, container.firstChild);
        } else {
            alert(message);
        }
    }
}

// 日付フォーマット
function formatDate(dateString) {
    if (!dateString) return '日付不明';
    
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '日付不明';
        
        return date.toLocaleDateString('ja-JP', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch (error) {
        return '日付不明';
    }
}

// デバウンス関数
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}
