{% extends "base.html" %}

{% block title %}学習 - 英語リスニングアプリ{% endblock %}

{% block content %}
<!-- 学習ヘッダー -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">
                    <i class="fas fa-headphones me-2"></i>リスニング学習
                </h2>
                <p class="text-muted mb-0">問題 #{{ question.id }} - {{ question.uploader.username if question.uploader else 'Unknown' }}</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('questions') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>問題一覧に戻る
                </a>
                <button class="btn btn-outline-primary" onclick="toggleTranscript()">
                    <i class="fas fa-eye me-2"></i>文字起こし
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 音声プレイヤー -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-play-circle me-2"></i>音声を聞く
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="audio-player-container">
                            <audio id="audioPlayer" controls class="w-100">
                                <source src="{{ url_for('static', filename='audio/' + question.audio_file) }}" type="audio/mpeg">
                                お使いのブラウザは音声再生に対応していません。
                            </audio>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="play-count-info">
                            <i class="fas fa-headphones fa-2x text-primary mb-2"></i>
                            <p class="mb-1"><strong>{{ question.play_count or 0 }}</strong>回再生</p>
                            <p class="text-muted small">平均スコア: {{ "%.1f"|format(question.avg_score or 0) }}点</p>
                        </div>
                    </div>
                </div>
                
                <!-- 音声コントロール -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn btn-outline-primary" onclick="playAudio()">
                                <i class="fas fa-play me-2"></i>再生
                            </button>
                            <button class="btn btn-outline-secondary" onclick="pauseAudio()">
                                <i class="fas fa-pause me-2"></i>一時停止
                            </button>
                            <button class="btn btn-outline-info" onclick="restartAudio()">
                                <i class="fas fa-redo me-2"></i>最初から
                            </button>
                            <button class="btn btn-outline-warning" onclick="slowAudio()">
                                <i class="fas fa-tachometer-alt me-2"></i>ゆっくり再生
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 問題と回答 -->
<div class="row">
    <!-- 左側: 問題表示 -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>問題
                </h5>
            </div>
            <div class="card-body">
                <div class="question-display">
                    <p class="question-text fs-5">{{ question.question_text }}</p>
                    
                    <!-- ヒント -->
                    <div class="hint-section mt-3" id="hintSection" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>ヒント:</strong> 音声を注意深く聞いて、空欄に入る単語を考えてください。
                        </div>
                    </div>
                    
                    <!-- 文字起こし（初期は非表示） -->
                    <div class="transcript-section mt-3" id="transcriptSection" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-file-text me-2"></i>
                            <strong>文字起こし:</strong>
                            <p class="mb-0 mt-2">{{ question.transcript or '文字起こしが利用できません' }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 回答入力 -->
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>回答を入力
                </h5>
            </div>
            <div class="card-body">
                <form id="answerForm">
                    <div class="mb-3">
                        <label for="userAnswer" class="form-label">あなたの回答</label>
                        <input type="text" 
                               class="form-control form-control-lg" 
                               id="userAnswer" 
                               name="userAnswer" 
                               placeholder="空欄に入る単語を入力してください"
                               required>
                        <div class="form-text">大文字小文字は区別されません</div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary" onclick="showHint()">
                            <i class="fas fa-lightbulb me-2"></i>ヒントを見る
                        </button>
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="fas fa-check me-2"></i>回答を送信
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 右側: 学習情報と結果 -->
    <div class="col-lg-4">
        <!-- 学習統計 -->
        <div class="card shadow mb-4">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>学習統計
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="stat-item">
                            <i class="fas fa-clock fa-2x text-primary mb-2"></i>
                            <p class="mb-1"><strong id="timeSpent">0</strong>秒</p>
                            <small class="text-muted">学習時間</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <i class="fas fa-play fa-2x text-success mb-2"></i>
                            <p class="mb-1"><strong id="playCount">0</strong>回</p>
                            <small class="text-muted">音声再生</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 採点結果 -->
        <div class="card shadow" id="resultCard" style="display: none;">
            <div class="card-header" id="resultHeader">
                <h6 class="mb-0" id="resultTitle">
                    <i class="fas fa-star me-2"></i>採点結果
                </h6>
            </div>
            <div class="card-body text-center">
                <div id="resultContent">
                    <!-- 結果がここに表示されます -->
                </div>
                
                <hr>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="nextQuestion()">
                        <i class="fas fa-arrow-right me-2"></i>次の問題
                    </button>
                    <button class="btn btn-outline-secondary" onclick="retryQuestion()">
                        <i class="fas fa-redo me-2"></i>もう一度挑戦
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 学習のヒント -->
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>学習のコツ
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        音声を2-3回聞いてから回答
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        前後の文脈を意識する
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        スペルを正確に覚える
                    </li>
                    <li>
                        <i class="fas fa-check-circle text-success me-2"></i>
                        間違えても諦めない
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// グローバル変数
let startTime = Date.now();
let playCount = 0;
let isAnswered = false;
let audioPlayer;

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    audioPlayer = document.getElementById('audioPlayer');
    setupEventListeners();
    startTimer();
});

// イベントリスナーの設定
function setupEventListeners() {
    // 音声再生イベント
    audioPlayer.addEventListener('play', function() {
        playCount++;
        updatePlayCount();
    });
    
    // 回答フォーム送信
    document.getElementById('answerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitAnswer();
    });
    
    // 音声終了時の処理
    audioPlayer.addEventListener('ended', function() {
        // 必要に応じて自動再生や次の処理
    });
}

// 音声再生
function playAudio() {
    audioPlayer.play();
}

// 音声一時停止
function pauseAudio() {
    audioPlayer.pause();
}

// 音声を最初から再生
function restartAudio() {
    audioPlayer.currentTime = 0;
    audioPlayer.play();
}

// ゆっくり再生
function slowAudio() {
    if (audioPlayer.playbackRate === 1.0) {
        audioPlayer.playbackRate = 0.75;
        showMessage('再生速度を0.75倍に設定しました', 'info');
    } else {
        audioPlayer.playbackRate = 1.0;
        showMessage('再生速度を通常に戻しました', 'info');
    }
}

// ヒント表示
function showHint() {
    const hintSection = document.getElementById('hintSection');
    hintSection.style.display = 'block';
    
    // ヒントボタンを無効化
    event.target.disabled = true;
    event.target.innerHTML = '<i class="fas fa-lightbulb me-2"></i>ヒント表示済み';
}

// 文字起こし表示切り替え
function toggleTranscript() {
    const transcriptSection = document.getElementById('transcriptSection');
    const button = event.target;
    
    if (transcriptSection.style.display === 'none') {
        transcriptSection.style.display = 'block';
        button.innerHTML = '<i class="fas fa-eye-slash me-2"></i>文字起こし非表示';
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-primary');
    } else {
        transcriptSection.style.display = 'none';
        button.innerHTML = '<i class="fas fa-eye me-2"></i>文字起こし';
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline-primary');
    }
}

// 回答送信
async function submitAnswer() {
    if (isAnswered) return;
    
    const userAnswer = document.getElementById('userAnswer').value.trim();
    if (!userAnswer) {
        showMessage('回答を入力してください', 'warning');
        return;
    }
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>採点中...';
    
    try {
        const response = await fetch('/api/submit_answer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question_id: {{ question.id }},
                user_answer: userAnswer
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            showResult(result);
        } else {
            throw new Error('回答の送信に失敗しました');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('回答の送信に失敗しました', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>回答を送信';
    }
}

// 結果表示
function showResult(result) {
    isAnswered = true;
    
    const resultCard = document.getElementById('resultCard');
    const resultHeader = document.getElementById('resultHeader');
    const resultTitle = document.getElementById('resultTitle');
    const resultContent = document.getElementById('resultContent');
    
    // 結果に応じてスタイルを変更
    if (result.is_correct) {
        resultHeader.className = 'card-header bg-success text-white';
        resultTitle.innerHTML = '<i class="fas fa-check-circle me-2"></i>正解！';
    } else {
        resultHeader.className = 'card-header bg-danger text-white';
        resultTitle.innerHTML = '<i class="fas fa-times-circle me-2"></i>不正解';
    }
    
    // 結果内容を表示
    resultContent.innerHTML = `
        <div class="result-summary mb-3">
            <h4 class="mb-2">${result.is_correct ? '素晴らしい！' : '頑張りましょう！'}</h4>
            <p class="mb-1"><strong>あなたの回答:</strong> ${result.user_answer}</p>
            <p class="mb-1"><strong>正解:</strong> ${result.correct_answer}</p>
            <p class="mb-0"><strong>スコア:</strong> ${result.score}点</p>
        </div>
        
        ${result.explanation ? `
        <div class="explanation mb-3">
            <h6>解説:</h6>
            <p class="mb-0">${result.explanation}</p>
        </div>
        ` : ''}
    `;
    
    resultCard.style.display = 'block';
    
    // 回答フォームを無効化
    document.getElementById('userAnswer').disabled = true;
    document.getElementById('submitBtn').disabled = true;
    
    // 学習時間を記録
    const timeSpent = Math.floor((Date.now() - startTime) / 1000);
    updateTimeSpent(timeSpent);
    
    // 結果をサーバーに送信（学習ログ）
    logLearningResult(result);
}

// 学習結果の記録
async function logLearningResult(result) {
    try {
        await fetch('/api/log_learning', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question_id: {{ question.id }},
                user_answer: result.user_answer,
                score: result.score,
                time_spent: Math.floor((Date.now() - startTime) / 1000)
            })
        });
    } catch (error) {
        console.error('学習ログの記録に失敗:', error);
    }
}

// 次の問題
function nextQuestion() {
    // 推奨コンテンツページに移動
    window.location.href = '/recommendations';
}

// 問題を再挑戦
function retryQuestion() {
    // ページをリロード
    location.reload();
}

// タイマー開始
function startTimer() {
    setInterval(updateTimeSpent, 1000);
}

// 学習時間更新
function updateTimeSpent(seconds) {
    const timeSpentElement = document.getElementById('timeSpent');
    if (timeSpentElement) {
        timeSpentElement.textContent = seconds;
    }
}

// 再生回数更新
function updatePlayCount() {
    const playCountElement = document.getElementById('playCount');
    if (playCountElement) {
        playCountElement.textContent = playCount;
    }
}

// メッセージ表示
function showMessage(message, type = 'info') {
    if (window.AppUtils) {
        window.AppUtils.showMessage(message, type);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}
